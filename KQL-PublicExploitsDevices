// gives you a list of devices per CVE that has publicly available exploits
let VulnerableSoftware = 
DeviceTvmSoftwareVulnerabilities
| join kind=inner (
    DeviceTvmSoftwareVulnerabilitiesKB
    | where VulnerabilitySeverityLevel in ("Critical", "High")
    | where IsExploitAvailable == true
) on CveId
| summarize VulnerableDevicesCount=dcount(DeviceId) by SoftwareName, SoftwareVersion, CveId, VulnerabilitySeverityLevel, IsExploitAvailable
| where VulnerableDevicesCount > 0
| order by VulnerableDevicesCount desc, VulnerabilitySeverityLevel desc;
VulnerableSoftware
| join kind=inner (
    DeviceTvmSoftwareVulnerabilities
    | distinct DeviceId, DeviceName, SoftwareName, SoftwareVersion, CveId
) on SoftwareName, SoftwareVersion, CveId
| summarize DevicesToUpdate=make_set(DeviceName) by SoftwareName, SoftwareVersion, CveId, VulnerabilitySeverityLevel, VulnerableDevicesCount, IsExploitAvailable
| extend DevicesToUpdate = array_sort_asc(DevicesToUpdate)
| project SoftwareName, SoftwareVersion, CveId, VulnerabilitySeverityLevel, VulnerableDevicesCount, IsExploitAvailable, DevicesToUpdate
